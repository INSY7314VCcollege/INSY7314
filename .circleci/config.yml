version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17
    working_directory: ~/project

jobs:
  test-and-sonar:
    executor: node-executor
    steps:
      - checkout

      # Install deps if folders exist (safe for any layout)
      - run:
          name: Install dependencies (if present)
          command: |
            if [ -f frontend/package.json ]; then cd frontend && npm ci; cd ..; else echo "no frontend"; fi
            if [ -f api/package.json ]; then cd api && npm ci; cd ..; else echo "no api"; fi

      # Run tests with coverage if scripts exist
      - run:
          name: Run tests (if present)
          command: |
            if [ -f frontend/package.json ]; then cd frontend && (npm run test:ci || npm test || true); cd ..; fi
            if [ -f api/package.json ]; then cd api && (npm run test:ci || npm test || true); cd ..; fi

      # Install SonarScanner CLI
      - run:
          name: Install SonarScanner
          command: |
            SCAN_VERSION="5.0.1.3006"
            curl -fsSL -o scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-${SCAN_VERSION}-linux.zip"
            unzip -q scanner.zip
            mv "sonar-scanner-${SCAN_VERSION}-linux" sonar-scanner
            echo 'export PATH="$PWD/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Confirm Sonar env vars exist (from your CircleCI context/project vars)
      - run:
          name: Check Sonar envs present
          command: |
            test -n "$SONAR_HOST_URL" || (echo "SONAR_HOST_URL missing"; exit 1)
            test -n "$SONAR_TOKEN" || (echo "SONAR_TOKEN missing"; exit 1)
            echo "Sonar envs detected."

      # Run analysis (works for SonarCloud or self-hosted)
      - run:
          name: Run Sonar analysis
          command: |
            EXTRA=""
            if [ -n "$SONAR_ORG" ]; then EXTRA="$EXTRA -Dsonar.organization=$SONAR_ORG"; fi
            if [ -z "$SONAR_PROJECT_KEY" ]; then SONAR_PROJECT_KEY="$CIRCLE_PROJECT_REPONAME"; fi
            sonar-scanner \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN" \
              -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
              $EXTRA

workflows:
  version: 2
  build_and_scan:
    jobs:
      - test-and-sonar:
          context:
            - INSY7314VCcollege  
