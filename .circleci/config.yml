version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17
    working_directory: ~/project

jobs:
  test-and-sonar:
    executor: node-executor
    steps:
      # Step 1: Checkout code
      - checkout

      # Step 2: Install frontend dependencies (adjust paths if you don't have a frontend folder)
      - restore_cache:
          keys:
            - v1-frontend-deps-{{ checksum "frontend/package-lock.json" }}
            - v1-frontend-deps-
      - run:
          name: Install frontend dependencies
          command: |
            cd frontend
            npm ci

      # Step 3: Install API dependencies (adjust paths if you don't have an API folder)
      - restore_cache:
          keys:
            - v1-api-deps-{{ checksum "api/package-lock.json" }}
            - v1-api-deps-
      - run:
          name: Install API dependencies
          command: |
            cd api
            npm ci

      # Step 4: Run frontend tests
      - run:
          name: Run frontend tests
          command: |
            cd frontend
            npm run test:ci || npm run test:ci --if-present

      # Step 5: Run API tests
      - run:
          name: Run API tests
          command: |
            cd api
            npm run test:ci || npm run test:ci --if-present

      # Step 6: Install SonarScanner
      - run:
          name: Install SonarScanner
          command: |
            SCAN_VERSION="5.0.1.3006"
            curl -fsSL -o scanner.zip \
              "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-${SCAN_VERSION}-linux.zip"
            unzip -q scanner.zip
            mv "sonar-scanner-${SCAN_VERSION}-linux" sonar-scanner
            echo 'export PATH="$PWD/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Step 7: Run SonarCloud analysis
      - run:
          name: Run SonarCloud analysis
          command: |
            sonar-scanner \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN" \
              -Dsonar.projectKey="$CIRCLE_PROJECT_REPONAME" \
              -Dsonar.organization="myorg"  # Replace 'myorg' with your SonarCloud organization name

workflows:
  version: 2
  build_and_scan:
    jobs:
      - test-and-sonar:
          context:
            - Sonar  # <-- This is your context containing SONAR_HOST_URL and SONAR_TOKEN
