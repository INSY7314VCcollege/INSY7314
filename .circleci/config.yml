version: 2.1

executors:
  # Define executor with Docker image
  node-executor:
    docker:
      - image: cimg/node:20.17  # Use an appropriate Node.js Docker image
    working_directory: ~/project

jobs:
  # Define the job that will run the SonarQube analysis
  test-and-sonar:
    executor: node-executor
    steps:
      - checkout  # Check out the code from GitHub

      # Install dependencies for the frontend
      - restore_cache:
          keys:
            - v1-frontend-deps-{{ checksum "frontend/package-lock.json" }}
            - v1-frontend-deps-
      - run:
          name: Install frontend dependencies
          command: |
            cd frontend
            npm ci

      # Install dependencies for the API
      - restore_cache:
          keys:
            - v1-api-deps-{{ checksum "api/package-lock.json" }}
            - v1-api-deps-
      - run:
          name: Install API dependencies
          command: |
            cd api
            npm ci

      # Run tests for the frontend
      - run:
          name: Run frontend tests
          command: |
            cd frontend
            npm run test:ci || npm run test:ci --if-present

      # Run tests for the API
      - run:
          name: Run API tests
          command: |
            cd api
            npm run test:ci || npm run test:ci --if-present

      # Install SonarScanner
      - run:
          name: Install SonarScanner
          command: |
            SCAN_VERSION="5.0.1.3006"
            curl -fsSL -o scanner.zip \
              "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-${SCAN_VERSION}-linux.zip"
            unzip -q scanner.zip
            mv "sonar-scanner-${SCAN_VERSION}-linux" sonar-scanner
            echo 'export PATH="$PWD/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Run SonarQube analysis
      - run:
          name: SonarQube analysis
          command: |
            sonar-scanner \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN"

# Define workflows to run jobs in sequence
workflows:
  version: 2
  build_and_scan:
    jobs:
      - test-and-sonar
